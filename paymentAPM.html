<!DOCTYPE html>
<html lang="es">  
<head>    
    <title>Payment APM</title>    
    <link href="https://paymentez.github.io/api-doc/images/favicon-d165b374.svg" rel="icon" type="image/svg">
    <meta charset="UTF-8">
    <meta name="title" content="Test Nuvei">
    <meta name="description" content="Descripción de la WEB"> 
    <link rel="stylesheet" type="text/css" href="style.css">    
   
</head>  
<body> 
  
    <header>
           
    </header>

</head>
<body>
<div class="navbar">
      <ul>
        <li><a href="welcome.html">Introduction</a></li>
        <li><a href="sessionToken.html">Session Token</a></li>
        <li><a href="openOrder.html">Open Order</a></li>
        <li><a href="initPayment.html">Init Payment</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle">Payment</a>
          <ul class="dropdown-menu">
            <li><a href="simpleCardRequest.html">Simple Card Request</a></li>
            <li><a href="fullCardRequest.html">Full Card Request</a></li>
            <li><a href="paymentAPM.html">Payment APM</a></li>
            <li><a href="#">Otro</a></li>
          </ul>
        </li>
        <li><a href="settleTransaction.html">Settle Transaction</a></li>
        <li><a href="refundTransaction.html">Refund Transaction</a></li>
        <li><a href="voidTransaction.html">Void Transaction</a></li>
        <li><a href="payout.html">Payout</a></li>
        <li><a href="getPaymentStatus.html">Get Payment Status</a></li>
        <li><a href="getPayoutStatus.html">Get Payout Status</a></li>
        <li><a href="accountCapture.html">Account Capture</a></li>  

    </ul>
</div>
    
  </head>
  <body>
    <div class='container'>
    <img class="image" src="https://cdn.paymentez.com/img/nv/nuvei_logo.png"> 
    <form>
        <input type="password" id="merchant_secret_key" name="merchant_secret_key" placeholder="Merchant Secret Key" required>
        <input type="text" id="merchant_id" name="merchant_id" placeholder="Merchant ID" required>

        <input type="text" id="merchant_site_id" name="merchant_site_id" placeholder="Merchant Site ID" required>

        <input type="text" id="client_request_id" name="client_request_id" placeholder="Client Request ID" required>

        <input type="text" id="sessionToken" name="sessionToken" placeholder="Session Token" required>

        <input type="number" id="amount" name="amount" placeholder="Amount" required>

        
        <label for="currency">Currency:</label>
        <select id="currency">
          <option value="#">Select</option>
          <option value="COP">COP</option>
          <option value="MXN">MXN</option>
          <option value="PEN">PEN</option>
          <option value="USD">USD</option>
        </select>

        <label for="payment_method">Payment Method:</label>
        <select id="payment_method" onchange="showFields()">
          <option value="#">Select</option>
          <option value="apmgw_Safetypay">SafetyPay</option>
          <option value="apmgw_PSE_PZ">PSE</option>
          <option value="apmgw_Oxxo">Oxxo</option>
          <option value="apmgw_Pago_Efectivo">Pago Efectivo</option>
        </select>

    <div id="apmgw_Safetypay" style="display: none;">

      <input type="text" id="firstName" name="firstName" placeholder="First Name">  
      <input type="text" id="lastName" name="lastName" placeholder="Last Name">

    </div>

    <div id="apmgw_PSE_PZ" style="display: none;">

      <input type="text" id="paymentez_userName" name="paymentez_userName" placeholder="User Name">

       <select id="paymentez_userType" >
          <option value="#">User Type</option>
          <option value="N">Natural</option>
          <option value="J">Jurídica</option>
        </select>

        <select id="paymentez_userFisNumber" >
          <option value="#">Type Fiscal</option>
          <option value="CC">Cédula de ciudadanía</option>
          <option value="CE">Cédula de extranjería</option>
          <option value="NIT">Número de identificación tributario</option>
          <option value="TI">Tarjeta de identidad</option>
          <option value="PP">Pasaporte</option> 
        </select>

      <input type="text" id="paymentez_fiscalNumber" name="paymentez_fiscalNumber" placeholder="Fiscal Number">
      <input type="text" id="paymentez_email" name="paymentez_email" placeholder="Email">

      <select id="paymentez_bankCode" >
          <option value="#">Bank</option>
          <option value="1022">Banco Union Colombiano</option>
        </select>
        

    </div>

    <div id="apmgw_Oxxo" style="display: none;">

      <input type="text" id="firstName" name="firstName" placeholder="First Name">
      <input type="text" id="lastName" name="lastName" placeholder="Last Name">
      <input type="text" id="email" name="email" placeholder="Email">

    </div>

    <div id="apmgw_Pago_Efectivo" style="display: none;">

      <input type="text" id="personal_id" name="personal_id" placeholder="Personal ID">
      <input type="text" id="firstName" name="firstName" placeholder="First Name">
      <input type="text" id="lastName" name="lastName" placeholder="Last Name">
      <input type="text" id="email" name="email" placeholder="Email">

    </div>

    

      <input type="button" value="Enviar" onclick="obtenerDatos()">
    </form>
    </div>
          <div id='result'></div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>  
 

<script type="text/javascript">

  function showFields() {
      var payment_method = document.getElementById("payment_method");
      var selectedOption = payment_method.value;

      var apmgw_Safetypay = document.getElementById("apmgw_Safetypay");
      var apmgw_PSE_PZ = document.getElementById("apmgw_PSE_PZ");
      var apmgw_Oxxo = document.getElementById("apmgw_Oxxo");
      var apmgw_Pago_Efectivo = document.getElementById("apmgw_Pago_Efectivo");

      apmgw_Safetypay.style.display = "none";
      apmgw_PSE_PZ.style.display = "none";
      apmgw_Oxxo.style.display = "none";
      apmgw_Pago_Efectivo.style.display = "none";

      if (selectedOption === "apmgw_Safetypay") {
        apmgw_Safetypay.style.display = "block";
      } else if (selectedOption === "apmgw_PSE_PZ") {
        apmgw_PSE_PZ.style.display = "block";
      } else if (selectedOption === "apmgw_Oxxo") {
        apmgw_Oxxo.style.display = "block";
      } else if (selectedOption === "apmgw_Pago_Efectivo") {
        apmgw_Pago_Efectivo.style.display = "block";
    }
  }



function obtenerDatos(){
    document.getElementById('result').innerHTML = '';
    var merchant_secret_key = document.getElementById('merchant_secret_key').value;
    var merchant_id = document.getElementById('merchant_id').value;
    var sessionToken = document.getElementById('sessionToken').value;
    var merchant_site_id = document.getElementById('merchant_site_id').value;
    var client_request_id = document.getElementById('client_request_id').value;
    var amount = document.getElementById('amount').value;
    var currency = document.getElementById('currency').value;
    var payment_method = document.getElementById('payment_method').value;

    if (!sessionToken || !amount ||!merchant_secret_key ||!merchant_id ||!merchant_site_id ||!client_request_id) {
      alert("Por favor ingrese todos los campos");
      return;
    }
  
const fecha = new Date();
const timestamp = `${fecha.getFullYear()}${padZero(fecha.getMonth() + 1)}${padZero(fecha.getDate())}${padZero(fecha.getHours())}${padZero(fecha.getMinutes())}${padZero(fecha.getSeconds())}`;

  function padZero(valor) {
    return valor.toString().padStart(2, '0');
  }
  
  const cadena =CryptoJS.SHA256(merchant_id + merchant_site_id + client_request_id + amount.toString() +currency + timestamp + merchant_secret_key);
  const checksum = cadena.toString();
 
  
    var myHeaders = new Headers();
    myHeaders.append("Content-Type", "application/json");

    var raw = {
    "sessionToken":sessionToken,
    "merchantId":merchant_id,
    "merchantSiteId":merchant_site_id,
    "clientRequestId":client_request_id,
    "amount":amount,
    "currency":currency,
    "userTokenId":"230811147",
    "clientUniqueId":"12345",
    "paymentOption":{
        "alternativePaymentMethod":{
            "paymentMethod":payment_method
        }
    },
    "billingAddress":{
        "firstName": "John",
        "lastName": "Smith",
        "email":"test@tes.com"
    },
    "deviceDetails":{
        "ipAddress":"192.168.2.38"
    },
    "userDetails":{
        "firstName": "John",
        "lastName": "Smith",
        "email":"test@test.com"
  },
    "timeStamp":timestamp,
    "checksum":checksum
};

  if (payment_method == 'apmgw_Safetypay'){

    var firstName = document.getElementById('firstName').value;
    var lastName = document.getElementById('lastName').value;
    raw.paymentOption.alternativePaymentMethod.firstName = firstName;
    raw.paymentOption.alternativePaymentMethod.lastName = lastName;
    raw.billingAddress.country ='PE';
    raw.userDetails.country ='PE';

  }
  else if (payment_method =='apmgw_PSE_PZ')
  {
    var paymentez_userName = document.getElementById('paymentez_userName').value;
    var paymentez_userType = document.getElementById('paymentez_userType').value;
    var paymentez_userFisNumber = document.getElementById('paymentez_userFisNumber').value;
    var paymentez_fiscalNumber = document.getElementById('paymentez_fiscalNumber').value;
    var paymentez_email = document.getElementById('paymentez_email').value;
    var paymentez_bankCode = document.getElementById('paymentez_bankCode').value;
    raw.paymentOption.alternativePaymentMethod.paymentez_userName = paymentez_userName;
    raw.paymentOption.alternativePaymentMethod.paymentez_userType = paymentez_userType;
    raw.paymentOption.alternativePaymentMethod.paymentez_userFisNumber = paymentez_userFisNumber;
    raw.paymentOption.alternativePaymentMethod.paymentez_fiscalNumber = paymentez_fiscalNumber;
    raw.paymentOption.alternativePaymentMethod.paymentez_email = paymentez_email;
    raw.paymentOption.alternativePaymentMethod.paymentez_bankCode = paymentez_bankCode;
    raw.billingAddress.country ='CO';
    raw.userDetails.country ='CO';
    

  }
   else if (payment_method =='apmgw_Oxxo')
  {
    var firstName = document.getElementById('firstName').value;
    var lastName = document.getElementById('lastName').value;
    var email = document.getElementById('email').value;
    raw.paymentOption.alternativePaymentMethod.firstName = firstName;
    raw.paymentOption.alternativePaymentMethod.lastName = lastName;
    raw.paymentOption.alternativePaymentMethod.email = email;
    raw.billingAddress.country ='MX';
    raw.userDetails.country ='MX';
    


  }
  else if (payment_method =='apmgw_Pago_Efectivo')
  {
    var personal_id = document.getElementById('personal_id').value;
    var firstName = document.getElementById('firstName').value;
    var lastName = document.getElementById('lastName').value;
    var email = document.getElementById('email').value;
    raw.paymentOption.alternativePaymentMethod.personal_id = personal_id;
    raw.paymentOption.alternativePaymentMethod.firstName = firstName;
    raw.paymentOption.alternativePaymentMethod.lastName = lastName;
    raw.paymentOption.alternativePaymentMethod.email = email;
    raw.billingAddress.country ='MX';
    raw.userDetails.country ='MX';

  }

  var nuevoJson = JSON.stringify(raw);

    var requestOptions = {
      method: 'POST',
      headers: myHeaders,
      body: nuevoJson,
      redirect: 'follow'
    };
  
    fetch("https://ppp-test.nuvei.com/ppp/api/v1/payment.do", requestOptions)
      .then(response => response.json())
      .then(result => {

        //const redirectUrl = result.paymentOption.redirectUrl
        //window.location.href = redirectUrl;
        //document.getElementById("redirectUrl").textContent = redirectUrl;
        document.getElementById('result').innerHTML = JSON.stringify(result, null, 2);
      })
      .catch(error => console.log('error', error)); 
}

</script>
</script>
<script src="index.js" type="text/javascript"></script>
</body>  
</html>

